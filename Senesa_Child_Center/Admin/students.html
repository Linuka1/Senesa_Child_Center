<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Enrollments - Senesa Child Center</title>
  <link rel="stylesheet" href="dashboard.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />

  <style>
    /* ===== HARD RESET to prevent any page-wide zoom/scale ===== */
    html, body {
      zoom: 1 !important;               /* Chrome/Edge */
      -ms-zoom: 1 !important;           /* Legacy Edge/IE */
      -webkit-text-size-adjust: 100% !important;
    }
    html, body, .main-content, .content,
    #app, #root {
      transform: none !important;       /* kill accidental transform scale */
      transform-origin: top left !important;
    }

    /* ===== Shared scale (match Teachers) ===== */
    :root{
      --cell-font:13.5px;   /* desktop */
      --cell-pad-y:10px;
      --cell-pad-x:10px;
    }

    .content{padding:30px}
    .page-head{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-bottom:16px}
    .filters{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .search{padding:10px 12px;border:1px solid #ddd;border-radius:8px;min-width:240px}
    .select{padding:10px 12px;border:1px solid #ddd;border-radius:8px}
    .btn-primary{background:#ff6b6b;color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
    .btn-ghost{background:#fff;border:1px solid #ddd;color:#333;padding:10px 14px;border-radius:8px;cursor:pointer}

    .btn-outline{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 14px;border:1px solid #ff6b6b;color:#ff6b6b;border-radius:999px;background:#fff;font-weight:600
    }
    .btn-outline:hover{background:#ff6b6b;color:#fff}

    /* ===== Layout sanity (same as Teachers) ===== */
    .sidebar{ width:250px; }                     /* matches dashboard.css */
    .main-content{
      margin-left:250px;                         /* sit beside sidebar */
      max-width:none;                            /* no narrowing */
    }

    /* ===== Table (mirrors Teachers) ===== */
    .table-wrap{ width:100%; overflow-x:hidden; -webkit-overflow-scrolling:touch; } /* no horizontal scroll */
    table.enroll{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      background:#fff;
      box-shadow:0 2px 6px rgba(0,0,0,.08);
      border-radius:12px;
      overflow:hidden;
    }
    table.enroll thead{ background:#f5f5f5; }
    table.enroll th, table.enroll td{
      padding:var(--cell-pad-y) var(--cell-pad-x);
      border-bottom:1px solid #eee;
      text-align:left;
      font-size:var(--cell-font);
      vertical-align:top;
      word-break:break-word;
      overflow-wrap:anywhere;
    }
    table.enroll th{ white-space:nowrap; word-break:normal; }

    /* width hints for balance */
    table.enroll th:nth-child(1){width:36px;}     /* ID */
    table.enroll th:nth-child(6){width:110px;}    /* Start */
    table.enroll th:nth-child(7){width:70px;}     /* Days */
    table.enroll th:nth-child(8){width:110px;}    /* Schedule */
    table.enroll th:nth-child(9){width:100px;}    /* Status */
    table.enroll th:nth-child(10){width:120px;}   /* Submitted */
    table.enroll th:nth-child(11){width:220px;}   /* Actions */

    .badge{padding:6px 10px;border-radius:999px;font-size:12px;font-weight:600;display:inline-block}
    .st-pending{background:#fff7ed;color:#9a3412}
    .st-approved{background:#e8f5e9;color:#2e7d32}
    .st-rejected{background:#fee2e2;color:#991b1b}

    .row-actions{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:6px;
      align-items:start;
    }
    .btn-sm{
      padding:6px 10px;border:none;border-radius:6px;cursor:pointer;font-size:12px;
      width:100%; display:inline-flex; align-items:center; justify-content:center; gap:6px;
    }
    .btn-view{background:#64748b;color:#fff}
    .btn-edit{background:#4CAF50;color:#fff}
    .btn-approve{background:#22c55e;color:#fff}
    .btn-reject{background:#ef4444;color:#fff}

    .empty{padding:30px;color:#777;text-align:center}

    /* ===== Same medium-screen downscale as Teachers ===== */
    @media (max-width:1280px){
      :root{ --cell-font:12.5px; --cell-pad-y:8px; --cell-pad-x:8px; }
      table.enroll th:nth-child(11){width:200px;}
    }

    /* ===== Mobile card layout (kept) ===== */
    @media (max-width:720px){
      table.enroll,
      table.enroll thead,
      table.enroll tbody,
      table.enroll th,
      table.enroll td,
      table.enroll tr { display:block; width:100%; }

      table.enroll thead { display:none; }

      table.enroll tr{
        background:#fff;
        border:1px solid #eee;
        border-radius:12px;
        margin-bottom:12px;
        box-shadow:0 2px 6px rgba(0,0,0,.06);
        overflow:hidden;
      }
      table.enroll td{
        border-bottom:1px solid #f1f1f1;
        padding:12px 14px;
        display:flex !important;
        align-items:flex-start;
        justify-content:space-between;
        gap:10px;
      }
      table.enroll td:last-child{ border-bottom:none; }

      table.enroll td::before{
        content: attr(data-col);
        font-weight:600;
        color:#6b7280;
        flex:0 0 45%;
        max-width:45%;
      }
      table.enroll td > *{
        flex:1 1 auto;
        text-align:right;
        word-break:break-word;
      }
      .row-actions{ width:100%; grid-template-columns:repeat(2,minmax(0,1fr)); gap:8px; }
      .btn-sm{ font-size:12px; }
    }

    /* ✅ Do NOT reserve space for the sidebar on mobile */
    @media (max-width: 900px){
      .main-content{
        margin-left: 0 !important;
        width: 100% !important;
      }
      .content{ padding:16px !important; }      /* softer padding on small screens */
    }

    /* ✅ When the sidebar is toggled as an overlay, don't push the content */
    .sidebar.active + .main-content{
      margin-left: 0 !important;
    }

    /* (optional) keep the sidebar off-canvas on mobile */
    @media (max-width: 900px){
      .sidebar{
        position: fixed;
        top: 0; left: -250px; width: 250px; height: 100%;
        transition: left .2s ease;
        z-index: 1000; /* sits above content when opened */
      }
      .sidebar.active{ left: 0; }
    }

  </style>
</head>

<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <h2><i class="fas fa-school"></i> Senesa Child Center - Admin</h2>
    <nav>
      <a href="dashboard.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
      <a href="students.html" class="active"><i class="fas fa-user-graduate"></i> Enrollments</a>
      <a href="teachers.html"><i class="fas fa-chalkboard-teacher"></i> Teachers</a>
      <a href="programs.html"><i class="fas fa-book-open"></i> Programs</a>
      <a href="gallery.html"><i class="fas fa-images"></i> Gallery</a>
      <a href="books.html"><i class="fas fa-book"></i> Books</a>
      <a href="messages.html"><i class="fas fa-envelope"></i> Messages</a>
      <a href="users.html"><i class="fas fa-users-cog"></i> Users</a>
      <a href="orders.html"><i class="fas fa-receipt"></i> Orders</a>
      <a href="settings.html"><i class="fas fa-cog"></i> Settings</a>
    </nav>
  </aside>

  <!-- Main -->
  <main class="main-content">
    <header class="topbar">
      <button class="sidebar-toggle"><i class="fas fa-bars"></i></button>
      <h1>Enrollments</h1>

      <div class="admin-info dropdown">
        <i class="fas fa-user-circle"></i> Admin <i class="fas fa-caret-down"></i>
        <ul class="dropdown-menu">
          <li><a href="profile.html">Profile</a></li>
          <li><a href="change-password.html">Change Password</a></li>
          <li><a href="#" id="logoutBtn">Logout</a></li>
        </ul>
      </div>

      <!-- logoutModal -->
      <div id="logoutModal" class="modal modal--confirm">
        <div class="modal-content">
          <span class="close">&times;</span>
          <h3>Confirm Logout</h3>
          <p>Are you sure you want to logout?</p>
          <div class="modal-buttons">
            <button id="confirmLogout" class="btn-danger">Yes, Logout</button>
            <button id="cancelLogout" class="btn-secondary">Cancel</button>
          </div>
        </div>
      </div>
    </header>

    <section class="content">
      <div style="margin-bottom:16px">
        <a href="dashboard.html" class="btn-outline"><i class="fas fa-arrow-left"></i> Back</a>
      </div>

      <div class="page-head">
        <div>
          <h2 style="margin:0;color:#333">Enrollment Requests</h2>
          <p style="margin:4px 0 0;color:#6b7280;font-size:13px">Review, add, and manage child enrollments.</p>
        </div>
        <div class="filters">
          <input id="searchBox" class="search" placeholder="Search child / parent / plan" />
          <select id="statusFilter" class="select">
            <option value="">All Statuses</option>
            <option value="Pending">Pending</option>
            <option value="Approved">Approved</option>
            <option value="Rejected">Rejected</option>
          </select>
          <button id="addBtn" class="btn-primary"><i class="fas fa-plus"></i> Add Enrollment</button>
          <button id="importBtn" class="btn-ghost"><i class="fas fa-file-import"></i> Import JSON</button>
          <input id="importInput" type="file" accept="application/json" style="display:none" />
          <button id="exportCsvBtn" class="btn-ghost"><i class="fas fa-file-export"></i> Export CSV</button>
        </div>
      </div>

      <div class="table-wrap">
        <table class="enroll">
          <thead>
            <tr>
              <th>ID</th>
              <th>Child</th>
              <th>Parent</th>
              <th>Nursery Choice</th>
              <th>Selected Plan</th>
              <th>Start</th>
              <th>Days</th>
              <th>Schedule</th>
              <th>Status</th>
              <th>Submitted</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div id="emptyState" class="empty" style="display:none;">No enrollments found.</div>
    </section>

    <footer style="text-align:center;padding:15px;margin-top:auto;background:#fff;box-shadow:0 -2px 5px rgba(0,0,0,.1);">
      &copy; 2025 Senesa Child Center. All rights reserved.
    </footer>
  </main>

  <!-- View Modal -->
  <div id="viewModal" class="modal">
    <div class="modal-content" style="max-width:520px">
      <span class="close" id="closeView">&times;</span>
      <h3>Enrollment Details</h3>
      <div id="viewBody" style="margin-top:10px;text-align:left;color:#444"></div>
      <div class="modal-buttons">
        <button class="btn-ghost" id="closeView2">Close</button>
      </div>
    </div>
  </div>

  <!-- Add/Edit Modal -->
  <div id="editModal" class="modal">
    <div class="modal-content" style="max-width:620px">
      <span class="close" id="closeEdit">&times;</span>
      <h3 id="editTitle">Add Enrollment</h3>
      <form id="enrollForm">
        <input type="hidden" id="enrollId" />

        <div class="form-group">
          <label for="childFirst">Child First Name</label>
          <input id="childFirst" required />
        </div>
        <div class="form-group">
          <label for="childLast">Child Last Name</label>
          <input id="childLast" required />
        </div>

        <div class="form-group">
          <label for="parentFirst">Parent First Name</label>
          <input id="parentFirst" required />
        </div>
        <div class="form-group">
          <label for="parentLast">Parent Last Name</label>
          <input id="parentLast" required />
        </div>

        <div class="form-group">
          <label for="parentEmail">Parent Email</label>
          <input id="parentEmail" type="email" />
        </div>
        <div class="form-group">
          <label for="parentPhone">Parent Phone</label>
          <input id="parentPhone" />
        </div>

        <div class="form-group">
          <label for="choice">Nursery Choice</label>
          <select id="choice" required>
            <option value="Only Nursery">Only Nursery</option>
            <option value="Nursery + Daycare">Nursery + Daycare</option>
          </select>
        </div>
        <div class="form-group">
          <label for="plan">Selected Plan (if Daycare)</label>
          <input id="plan" placeholder="e.g., Full-Day Adventure" />
        </div>

        <div class="form-group">
          <label for="startDate">Start Date</label>
          <input id="startDate" type="date" />
        </div>
        <div class="form-group">
          <label for="daysPerWeek">Days/Week</label>
          <select id="daysPerWeek">
            <option value=""></option>
            <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
          </select>
        </div>
        <div class="form-group">
          <label for="schedule">Schedule</label>
          <select id="schedule">
            <option>Full Day</option>
            <option>Half Day (AM)</option>
            <option>Half Day (PM)</option>
          </select>
        </div>

        <div class="form-group">
          <label for="status">Status</label>
          <select id="status" required>
            <option>Pending</option>
            <option>Approved</option>
            <option>Rejected</option>
          </select>
        </div>

        <div class="modal-buttons">
          <button class="btn-primary" type="submit">Save</button>
          <button class="btn-ghost" type="button" id="cancelEdit">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    /* ===== shared sidebar/dropdown/logout (reuse from Teachers) ===== */
    const adminInfo    = document.querySelector('.admin-info');
    const dropdownMenu = adminInfo?.querySelector('.dropdown-menu');
    const logoutBtn    = document.getElementById('logoutBtn');
    const logoutModal  = document.getElementById('logoutModal');
    const closeLogout  = logoutModal?.querySelector('.close');
    const confirmLogout= document.getElementById('confirmLogout');
    const cancelLogout = document.getElementById('cancelLogout');
    const toggleBtn    = document.querySelector('.sidebar-toggle');
    const sidebar      = document.querySelector('.sidebar');

    adminInfo?.addEventListener('click', (e)=>{ e.stopPropagation(); dropdownMenu?.classList.toggle('show'); });
    document.addEventListener('click', ()=> dropdownMenu?.classList.remove('show'));
    logoutBtn?.addEventListener('click', (e)=>{
      e.preventDefault();
      if (!logoutModal) return;
      logoutModal.style.display = 'flex';
      dropdownMenu?.classList.remove('show');
      document.body.classList.add('modal-open');
    });
    function closeLogoutModal(){
      if (!logoutModal) return;
      logoutModal.style.display = 'none';
      document.body.classList.remove('modal-open');
    }
    closeLogout?.addEventListener('click', closeLogoutModal);
    cancelLogout?.addEventListener('click', closeLogoutModal);
    window.addEventListener('click', (e)=>{ if(e.target === logoutModal) closeLogoutModal(); });
    document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && logoutModal?.style.display === 'flex') closeLogoutModal(); });
    confirmLogout?.addEventListener('click', ()=>{ document.body.classList.remove('modal-open'); window.location.href = 'admin-login.html'; });
    toggleBtn?.addEventListener('click', ()=> sidebar?.classList.toggle('active'));

    /* ===== Enrollments logic ===== */
    const STORAGE_KEY = 'senesa_enrollments_v2';
    const seed = [
      {
        id: 1,
        child: { first: 'Aiden', last: 'Perera', dob: '2021-05-04', gender: 'Male' },
        parent: { first: 'Nuwan', last: 'Perera', email: 'nuwan@mail.com', phone: '+94 71 111 2222' },
        address: { line: '12 Flower Rd', city: 'Colombo' },
        emergency: { name: 'Mira', phone: '+94 77 333 4444' },
        medical: { allergies: '', specialNeeds: '' },
        choice: 'Nursery + Daycare',
        plan: 'Full-Day Adventure',
        startDate: '2025-09-15',
        daysPerWeek: '5',
        schedule: 'Full Day',
        extras: ['Meals Included'],
        consents: { medical: true, policy: true, photo: false },
        signature: { name: 'Nuwan Perera', date: '2025-09-05' },
        status: 'Rejected',
        submittedAt: '2025-09-05'
      }
    ];
    const load = ()=> JSON.parse(localStorage.getItem(STORAGE_KEY) || 'null') || seed.slice();
    const save = arr => localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
    let data = load();

    const tbody = document.getElementById('tbody');
    const emptyState = document.getElementById('emptyState');
    const searchBox = document.getElementById('searchBox');
    const statusFilter = document.getElementById('statusFilter');

    function badge(status){
      const cls = status==='Approved'?'st-approved':(status==='Rejected'?'st-rejected':'st-pending');
      return `<span class="badge ${cls}">${status}</span>`;
    }

    function render(){
      const q = (searchBox.value||'').toLowerCase();
      const st = statusFilter.value;
      tbody.innerHTML = '';
      const filtered = data.filter(r=>{
        const match = !q || [r.child.first, r.child.last, r.parent.first, r.parent.last, r.plan, r.choice]
          .filter(Boolean)
          .some(v=>String(v).toLowerCase().includes(q));
        const matchSt = !st || r.status===st;
        return match && matchSt;
      });

      if(!filtered.length){ emptyState.style.display='block'; return; }
      emptyState.style.display='none';

      filtered.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td data-col="ID"><span>${r.id}</span></td>
          <td data-col="Child"><span>${r.child.first} ${r.child.last}</span></td>
          <td data-col="Parent"><span>${r.parent.first} ${r.parent.last}</span></td>
          <td data-col="Nursery Choice"><span>${r.choice}</span></td>
          <td data-col="Selected Plan"><span>${r.plan}</span></td>
          <td data-col="Start"><span>${r.startDate || '—'}</span></td>
          <td data-col="Days"><span>${r.daysPerWeek || '—'}</span></td>
          <td data-col="Schedule"><span>${r.schedule || '—'}</span></td>
          <td data-col="Status"><span>${badge(r.status)}</span></td>
          <td data-col="Submitted"><span>${r.submittedAt || '—'}</span></td>
          <td data-col="Actions">
            <div class="row-actions">
              <button class="btn-sm btn-view" data-id="${r.id}"><i class="fas fa-eye"></i> View</button>
              <button class="btn-sm btn-edit" data-id="${r.id}"><i class="fas fa-edit"></i> Edit</button>
              <button class="btn-sm btn-approve" data-id="${r.id}" data-act="approve"><i class="fas fa-check"></i> Approve</button>
              <button class="btn-sm btn-reject" data-id="${r.id}" data-act="reject"><i class="fas fa-times"></i> Reject</button>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }
    render();
    searchBox.addEventListener('input', render);
    statusFilter.addEventListener('change', render);

    // view
    const viewModal = document.getElementById('viewModal');
    const viewBody = document.getElementById('viewBody');
    const closeView = document.getElementById('closeView');
    const closeView2 = document.getElementById('closeView2');
    [closeView, closeView2].forEach(el=> el.addEventListener('click', ()=> viewModal.style.display='none'));
    window.addEventListener('click', e=> { if(e.target===viewModal) viewModal.style.display='none'; });

    // add/edit
    const editModal = document.getElementById('editModal');
    const closeEdit = document.getElementById('closeEdit');
    const cancelEdit = document.getElementById('cancelEdit');
    const editTitle = document.getElementById('editTitle');
    const enrollForm = document.getElementById('enrollForm');
    const enrollId = document.getElementById('enrollId');
    const childFirst   = document.getElementById('childFirst');
    const childLast    = document.getElementById('childLast');
    const parentFirst  = document.getElementById('parentFirst');
    const parentLast   = document.getElementById('parentLast');
    const parentEmail  = document.getElementById('parentEmail');
    const parentPhone  = document.getElementById('parentPhone');
    const choice       = document.getElementById('choice');
    const plan         = document.getElementById('plan');
    const startDateEl  = document.getElementById('startDate');
    const daysPerWeek  = document.getElementById('daysPerWeek');
    const scheduleEl   = document.getElementById('schedule');
    const statusEl     = document.getElementById('status');

    function openAdd(){
      editTitle.textContent='Add Enrollment';
      enrollId.value='';
      childFirst.value=''; childLast.value='';
      parentFirst.value=''; parentLast.value='';
      parentEmail.value=''; parentPhone.value='';
      choice.value='Only Nursery';
      plan.value='';
      startDateEl.value='';
      daysPerWeek.value='';
      scheduleEl.value='Full Day';
      statusEl.value='Pending';
      editModal.style.display='flex';
      document.body.classList.add('modal-open');
    }
    function openEdit(row){
      editTitle.textContent='Edit Enrollment';
      enrollId.value = row.id;
      childFirst.value  = row.child.first || '';
      childLast.value   = row.child.last  || '';
      parentFirst.value = row.parent.first || '';
      parentLast.value  = row.parent.last  || '';
      parentEmail.value = row.parent.email || '';
      parentPhone.value = row.parent.phone || '';
      choice.value      = row.choice || 'Only Nursery';
      plan.value        = row.plan || (row.choice==='Only Nursery' ? 'Only Nursery' : '');
      startDateEl.value = row.startDate || '';
      daysPerWeek.value = row.daysPerWeek || '';
      scheduleEl.value  = row.schedule || 'Full Day';
      statusEl.value    = row.status || 'Pending';
      editModal.style.display='flex';
      document.body.classList.add('modal-open');
    }
    function closeEditModal(){
      editModal.style.display='none';
      document.body.classList.remove('modal-open');
    }

    closeEdit.addEventListener('click', closeEditModal);
    cancelEdit.addEventListener('click', closeEditModal);
    window.addEventListener('click', e=> { if(e.target===editModal) closeEditModal(); });
    document.getElementById('addBtn').addEventListener('click', openAdd);

    tbody.addEventListener('click', (e)=>{
      const btn = e.target.closest('button'); if(!btn) return;
      const id = Number(btn.dataset.id);
      const row = data.find(x=>x.id===id);
      if(btn.classList.contains('btn-view')){
        viewBody.innerHTML = `
          <h4>Parent</h4>
          <p><strong>Name:</strong> ${row.parent.first} ${row.parent.last}</p>
          <p><strong>Email:</strong> ${row.parent.email || '—'}</p>
          <p><strong>Phone:</strong> ${row.parent.phone || '—'}</p>
          <p><strong>Address:</strong> ${row.address?.line || '—'}, ${row.address?.city || ''}</p>
          <h4>Child</h4>
          <p><strong>Name:</strong> ${row.child.first} ${row.child.last}</p>
          <p><strong>DOB:</strong> ${row.child.dob || '—'} <strong>Gender:</strong> ${row.child.gender || '—'}</p>
          <p><strong>Allergies:</strong> ${row.medical?.allergies || '—'}</p>
          <p><strong>Special Needs:</strong> ${row.medical?.specialNeeds || '—'}</p>
          <h4>Plan</h4>
          <p><strong>Choice:</strong> ${row.choice}</p>
          <p><strong>Selected Plan:</strong> ${row.plan}</p>
          <p><strong>Start:</strong> ${row.startDate || '—'} • <strong>Days/Week:</strong> ${row.daysPerWeek || '—'} • <strong>Schedule:</strong> ${row.schedule || '—'}</p>
          <p><strong>Extras:</strong> ${(row.extras||[]).join(', ') || '—'}</p>
          <h4>Emergency & Consents</h4>
          <p><strong>Emergency:</strong> ${row.emergency?.name || '—'} ${row.emergency?.phone? '('+row.emergency.phone+')':''}</p>
          <p><strong>Consents:</strong> Medical: ${row.consents?.medical?'Yes':'No'}, Policy: ${row.consents?.policy?'Yes':'No'}, Photo: ${row.consents?.photo?'Yes':'No'}</p>
          <p><strong>Signature:</strong> ${row.signature?.name || '—'} ${row.signature?.date? '— '+row.signature.date:''}</p>
        `;
        viewModal.style.display='flex';
      } else if(btn.classList.contains('btn-edit')){
        openEdit(row);
      } else if(btn.dataset.act==='approve' || btn.dataset.act==='reject'){
        row.status = btn.dataset.act==='approve' ? 'Approved' : 'Rejected';
        save(data); render();
      }
    });

    enrollForm.addEventListener('submit', (e)=>{
      e.preventDefault();
      const id = enrollId.value ? Number(enrollId.value) : null;
      const payload = {
        child:  { first: childFirst.value.trim(),  last: childLast.value.trim() },
        parent: { first: parentFirst.value.trim(), last: parentLast.value.trim(), email: parentEmail.value.trim(), phone: parentPhone.value.trim() },
        choice: choice.value,
        plan:   choice.value === 'Nursery + Daycare' ? (plan.value.trim() || '—') : 'Only Nursery',
        startDate:  startDateEl.value,
        daysPerWeek: daysPerWeek.value,
        schedule:   scheduleEl.value,
        status:     statusEl.value,
      };
      if(id){
        const i = data.findIndex(x=>x.id===id);
        if(i>-1){ data[i] = { ...data[i], ...payload }; }
      }else{
        const next = data.length ? Math.max(...data.map(x=>x.id))+1 : 1;
        data.push({
          id: next,
          ...payload,
          submittedAt: new Date().toISOString().slice(0,10),
          address:   { line:'', city:'' },
          emergency: { name:'', phone:'' },
          medical:   { allergies:'', specialNeeds:'' },
          extras: [],
          consents: { medical:false, policy:false, photo:false },
          signature: { name:'', date:'' }
        });
      }
      save(data); render(); closeEditModal();
    });

    // Import
    const importBtn = document.getElementById('importBtn');
    const importInput = document.getElementById('importInput');
    importBtn.addEventListener('click', ()=> importInput.click());
    importInput.addEventListener('change', ()=>{
      const file = importInput.files[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try{
          const payload = JSON.parse(reader.result);
          const nurChoice = payload['nursery-plan'] === 'only-nursery' ? 'Only Nursery'
                         : payload['nursery-plan'] === 'nursery-and-daycare' ? 'Nursery + Daycare'
                         : '—';
          const selectedPlan = nurChoice === 'Nursery + Daycare' ? (payload.plan || '—') : 'Only Nursery';
          const row = {
            id: data.length ? Math.max(...data.map(x=>x.id))+1 : 1,
            child: { first: payload.childFirst||'', last: payload.childLast||'', dob: payload.dob||'', gender: payload.gender||'' },
            parent:{ first: payload.parentFirst||'', last: payload.parentLast||'', email: payload.parentEmail||'', phone: payload.parentPhone||'' },
            address:{ line: payload.address||'', city: payload.city||'' },
            emergency:{ name: payload.emergencyName||'', phone: payload.emergencyPhone||'' },
            medical:{ allergies: payload.allergies||'', specialNeeds: payload.specialNeeds||'' },
            choice: nurChoice,
            plan: selectedPlan,
            startDate: payload.startDate||'',
            daysPerWeek: payload.daysPerWeek||'',
            schedule: payload.schedule||'',
            extras: Array.isArray(payload.extras)? payload.extras: [],
            consents:{ medical: !!payload.consentMedical, policy: !!payload.consentPolicy, photo: !!payload.consentPhoto },
            signature:{ name: payload.signature||'', date: payload.signDate||'' },
            status: 'Pending',
            submittedAt: (payload.timestamp || new Date().toISOString()).slice(0,10)
          };
          data.push(row); save(data); render();
          alert('Application imported successfully.');
        }catch(err){
          console.error(err); alert('Invalid JSON file.');
        }
        importInput.value = '';
      };
      reader.readAsText(file);
    });

    // Export CSV
    document.getElementById('exportCsvBtn').addEventListener('click', ()=>{
      const rows = [[
        'ID','Child First','Child Last','Parent First','Parent Last','Email','Phone',
        'Nursery Choice','Selected Plan','Start Date','Days/Week','Schedule','Status','Submitted'
      ]].concat(
        data.map(r=>[
          r.id, r.child.first, r.child.last, r.parent.first, r.parent.last, r.parent.email, r.parent.phone,
          r.choice, r.plan, r.startDate, r.daysPerWeek, r.schedule, r.status, r.submittedAt
        ])
      );
      const csv = rows.map(r=>r.map(x=>`"${String(x??'').replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'enrollments.csv';
      a.click();
      URL.revokeObjectURL(a.href);
    });
  </script>
</body>
</html>
