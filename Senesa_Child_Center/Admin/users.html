<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Users Management - Senesa Child Center</title>
  <link rel="stylesheet" href="dashboard.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
  <style>
    /* ===== BASE ===== */
    .content{ padding:30px; }
    .users-header{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      flex-wrap:wrap; margin-bottom:16px;
    }
    .users-header h2{ margin:0; color:#333; }
    .users-actions{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .search-input{ padding:10px 12px; border:1px solid #ddd; border-radius:8px; min-width:260px; }

    .btn-primary{ background:#ff6b6b; color:#fff; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; }
    .btn-ghost{ background:#fff; border:1px solid #ddd; color:#333; padding:8px 12px; border-radius:8px; cursor:pointer; }

    .table-wrap{ width:100%; overflow-x:hidden; }   /* no sideways scroll */
    table.users{
      width:100%;
      border-collapse:separate; border-spacing:0; background:#fff;
      box-shadow:0 2px 6px rgba(0,0,0,.08); border-radius:12px; overflow:hidden;
    }
    table.users thead{ background:#f5f5f5; }
    table.users th, table.users td{
      padding:12px 14px; text-align:left; border-bottom:1px solid #eee; font-size:14px;
    }
    table.users th{ color:#555; white-space:nowrap; }
    table.users tr:hover td{ background:#fafafa; }

    .badge{ padding:6px 10px; border-radius:999px; font-size:12px; font-weight:600; display:inline-block; }
    .role-admin{ background:#ffe6e6; color:#e63946; }
    .role-parent{ background:#e8f5e9; color:#2e7d32; }
    .status-active{ background:#e8f0ff; color:#1e40af; }
    .status-blocked{ background:#fff1f2; color:#be123c; }
    .row-actions{ display:flex; gap:8px; flex-wrap:wrap; }
    .btn-small{ padding:6px 10px; border:none; border-radius:6px; cursor:pointer; font-size:12px; }
    .btn-edit{ background:#4CAF50; color:#fff; }
    .btn-block{ background:#e63946; color:#fff; }
    .btn-unblock{ background:#1e90ff; color:#fff; }
    .empty{ text-align:center; padding:30px; color:#777; }

    /* ===== DESKTOP LAYOUT (same as others) ===== */
    .sidebar{ width:250px; }
    .main-content{ margin-left:250px; }

    /* ===== MOBILE LAYOUT (no horizontal scroll) ===== */
    @media (max-width:900px){
      .main-content{ margin-left:0 !important; width:100% !important; }
      .content{ padding:16px !important; }

      .users-header{ align-items:flex-start; }
      .users-actions{ width:100%; }
      .search-input{ width:100%; min-width:0; }

      /* sidebar becomes drawer */
      .sidebar{
        position:fixed; top:0; left:-250px; width:250px; height:100%;
        transition:left .2s ease; z-index:1000;
      }
      .sidebar.active{ left:0; }
    }

    /* ===== CARD TABLE on small screens (like Enrollments) ===== */
    @media (max-width:720px){
      table.users, table.users thead, table.users tbody,
      table.users th, table.users td, table.users tr{ display:block; width:100%; }

      table.users thead{ display:none; }

      table.users tr{
        background:#fff; border:1px solid #eee; border-radius:12px;
        margin-bottom:12px; box-shadow:0 2px 6px rgba(0,0,0,.06); overflow:hidden;
      }
      table.users td{
        border-bottom:1px solid #f1f1f1;
        padding:12px 14px;
        display:flex !important; align-items:flex-start; justify-content:space-between; gap:10px;
      }
      table.users td:last-child{ border-bottom:none; }

      table.users td::before{
        content:attr(data-col);
        font-weight:600; color:#6b7280; flex:0 0 45%; max-width:45%;
      }
      table.users td > *{
        flex:1 1 auto; text-align:right; word-break:break-word;
      }

      .row-actions{ width:100%; display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:8px; }
      .btn-small{ font-size:12px; }
    }

    /* ===== SAFETY (avoid accidental scaling) ===== */
    html, body, #root, #app, .main-content, .content{
      transform:none !important; transform-origin:top left !important;
      -webkit-text-size-adjust:100% !important; zoom:1 !important;
    }

  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <h2><i class="fas fa-school"></i> Senesa Child Center - Admin</h2>
    <nav>
      <a href="dashboard.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
      <a href="students.html"><i class="fas fa-user-graduate"></i> Enrollments</a>
      <a href="teachers.html"><i class="fas fa-chalkboard-teacher"></i> Teachers</a>
      <a href="programs.html"><i class="fas fa-book-open"></i> Programs</a>
      <a href="gallery.html"><i class="fas fa-images"></i> Gallery</a>
      <a href="books.html"><i class="fas fa-book"></i> Books</a>
      <a href="messages.html"><i class="fas fa-envelope"></i> Messages</a>
      <a href="users.html" class="active"><i class="fas fa-users-cog"></i> Users</a>
      <a href="orders.html"><i class="fas fa-receipt"></i> Orders</a>
      <a href="settings.html"><i class="fas fa-cog"></i> Settings</a>
    </nav>
  </aside>

  <!-- Main -->
  <main class="main-content">
    <header class="topbar">
      <button class="sidebar-toggle"><i class="fas fa-bars"></i></button>
      <h1>Users</h1>
      <div class="admin-info dropdown">
        <i class="fas fa-user-circle"></i> Admin <i class="fas fa-caret-down"></i>
        <ul class="dropdown-menu">
          <li><a href="profile.html">Profile</a></li>
          <li><a href="change-password.html">Change Password</a></li>
          <li><a href="#" id="logoutBtn">Logout</a></li>
        </ul>
      </div>

      <script>
        // Save current page before navigating via dropdown
        document.querySelectorAll('.dropdown-menu a').forEach(a => {
          const href = a.getAttribute('href') || '';
          if (href.includes('change-password.html') || href.includes('profile.html')) {
            a.addEventListener('click', () => {
              sessionStorage.setItem('returnTo', window.location.href);
            });
          }
        });
      </script>

      <!-- logoutModal -->
      <div id="logoutModal" class="modal modal--confirm">
        <div class="modal-content">
          <span class="close">&times;</span>
          <h3>Confirm Logout</h3>
          <p>Are you sure you want to logout?</p>
          <div class="modal-buttons">
            <button id="confirmLogout" class="btn-danger">Yes, Logout</button>
            <button id="cancelLogout" class="btn-secondary">Cancel</button>
          </div>
        </div>
      </div>
    </header>

    <section class="content">
      <!-- Back button to match other pages -->
      <div style="margin-bottom:16px">
        <a href="dashboard.html" class="btn-outline btn-outline-primary"><i class="fas fa-arrow-left"></i> Back</a>
      </div>

      <div class="users-header">
        <h2>Users Management</h2>
        <div class="users-actions">
          <input id="searchBox" class="search-input" type="text" placeholder="Search by name or email..." />
          <button id="addUserBtn" class="btn-primary"><i class="fas fa-user-plus"></i> Add User</button>
          <button id="importBtn" class="btn-ghost"><i class="fas fa-file-import"></i> Import JSON</button>
          <input id="importInput" type="file" accept="application/json" style="display:none" />
          <button id="exportCsvBtn" class="btn-ghost"><i class="fas fa-file-export"></i> Export CSV</button>
        </div>
      </div>

      <div class="table-wrap">
        <table class="users" id="usersTable">
          <thead>
            <tr>
              <th style="width:60px;">ID</th>
              <th>Name</th>
              <th>Email</th>
              <th style="width:120px;">Role</th>
              <th style="width:120px;">Status</th>
              <th style="width:220px;">Actions</th>
            </tr>
          </thead>
          <tbody id="usersTbody"></tbody>
        </table>
        <div id="emptyState" class="empty" style="display:none;">No users found.</div>
      </div>
    </section>

    <footer style="text-align:center; padding:15px; margin-top:auto; background:#fff; box-shadow:0 -2px 5px rgba(0,0,0,0.1);">
      &copy; 2025 Senesa Child Center. All rights reserved.
    </footer>
  </main>

  <!-- Edit/Add User Modal -->
  <div id="userModal" class="modal">
    <div class="modal-content" style="max-width:520px;">
      <span class="close" id="closeUserModal">&times;</span>
      <h3 id="userModalTitle">Edit User</h3>
      <form id="userForm">
        <input type="hidden" id="userId" />
        <div class="form-group">
          <label for="userName">Full Name</label>
          <input type="text" id="userName" required />
        </div>
        <div class="form-group">
          <label for="userEmail">Email</label>
          <input type="email" id="userEmail" required />
        </div>
        <div class="form-group">
          <label for="userRole">Role</label>
          <select id="userRole" required>
            <option value="Admin">Admin</option>
            <option value="Parent">Parent</option>
          </select>
        </div>
        <div class="modal-buttons" style="margin-top:10px;">
          <button type="submit" class="btn-primary">Save</button>
          <button type="button" id="cancelUser" class="btn-ghost">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Block/Unblock Confirm Modal -->
  <div id="blockModal" class="modal">
    <div class="modal-content" style="max-width:420px;">
      <span class="close" id="closeBlockModal">&times;</span>
      <h3 id="blockTitle">Block User</h3>
      <p id="blockMessage">Are you sure?</p>
      <div class="modal-buttons">
        <button id="confirmBlock" class="btn-primary">Confirm</button>
        <button id="cancelBlock" class="btn-ghost">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Scripts: dropdown + sidebar + users logic -->
  <script>
    // sidebar & dropdown & logout (shared)
    const adminInfo    = document.querySelector('.admin-info');
    const dropdownMenu = adminInfo?.querySelector('.dropdown-menu');
    const logoutBtn    = document.getElementById('logoutBtn');
    const logoutModal  = document.getElementById('logoutModal');
    const closeLogout  = logoutModal?.querySelector('.close');
    const confirmLogout= document.getElementById('confirmLogout');
    const cancelLogout = document.getElementById('cancelLogout');
    const toggleBtn    = document.querySelector('.sidebar-toggle');
    const sidebar      = document.querySelector('.sidebar');

    adminInfo?.addEventListener('click', (e)=>{ e.stopPropagation(); dropdownMenu?.classList.toggle('show'); });
    document.addEventListener('click', ()=> dropdownMenu?.classList.remove('show'));

    logoutBtn?.addEventListener('click', (e)=>{
      e.preventDefault();
      if (!logoutModal) return;
      logoutModal.style.display = 'flex';
      dropdownMenu?.classList.remove('show');
      document.body.classList.add('modal-open');
    });
    function closeLogoutModal(){
      if (!logoutModal) return;
      logoutModal.style.display = 'none';
      document.body.classList.remove('modal-open');
    }
    closeLogout?.addEventListener('click', closeLogoutModal);
    cancelLogout?.addEventListener('click', closeLogoutModal);
    window.addEventListener('click', (e)=>{ if(e.target === logoutModal) closeLogoutModal(); });
    document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && logoutModal?.style.display === 'flex') closeLogoutModal(); });
    confirmLogout?.addEventListener('click', ()=>{ document.body.classList.remove('modal-open'); window.location.href = 'admin-login.html'; });

    // sidebar toggle
    toggleBtn?.addEventListener('click', ()=> sidebar?.classList.toggle('active'));

    // ----- Users data (mock) -----
    const STORAGE_KEY = 'senesa_users_v1';
    const currentAdminRole = 'Super Admin'; // change to 'Admin' to see role-based limits

    const seedUsers = [
      { id: 1, name: 'John Doe',   email: 'john@example.com',   role: 'Parent', status: 'Active' },
      { id: 2, name: 'Jane Smith', email: 'jane@example.com',   role: 'Admin',  status: 'Blocked' },
      { id: 3, name: 'Mary Lee',   email: 'mary.lee@mail.com',  role: 'Parent', status: 'Active' },
      { id: 4, name: 'Alex Kim',   email: 'alex.kim@mail.com',  role: 'Parent', status: 'Active' }
    ];

    const loadUsers = () => {
      const json = localStorage.getItem(STORAGE_KEY);
      return json ? JSON.parse(json) : seedUsers.slice();
    };
    const saveUsers = (arr) => localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));

    let users = loadUsers();

    // ----- Render -----
    const tbody = document.getElementById('usersTbody');
    const emptyState = document.getElementById('emptyState');
    const searchBox = document.getElementById('searchBox');

    function badgeRole(role){
      return `<span class="badge ${role==='Admin'?'role-admin':'role-parent'}">${role}</span>`;
    }
    function badgeStatus(status){
      return `<span class="badge ${status==='Active'?'status-active':'status-blocked'}">${status}</span>`;
    }

    function render(filter=''){
    tbody.innerHTML='';
    const q = (filter||'').trim().toLowerCase();
    const filtered = users.filter(u =>
      !q || u.name.toLowerCase().includes(q) || u.email.toLowerCase().includes(q)
    );

    emptyState.style.display = filtered.length ? 'none' : 'block';

    filtered.forEach(u=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td data-col="ID"><span>${u.id}</span></td>
        <td data-col="Name"><span>${u.name}</span></td>
        <td data-col="Email"><span>${u.email}</span></td>
        <td data-col="Role"><span>${badgeRole(u.role)}</span></td>
        <td data-col="Status"><span>${badgeStatus(u.status)}</span></td>
        <td data-col="Actions">
          <div class="row-actions">
            <button class="btn-small btn-edit" data-id="${u.id}"><i class="fas fa-edit"></i> Edit</button>
            ${
              currentAdminRole==='Super Admin'
              ? (u.status==='Active'
                  ? `<button class="btn-small btn-block" data-id="${u.id}" data-action="block"><i class="fas fa-ban"></i> Block</button>`
                  : `<button class="btn-small btn-unblock" data-id="${u.id}" data-action="unblock"><i class="fas fa-unlock"></i> Unblock</button>`)
              : ''
            }
          </div>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }


    render();

    // ----- Search -----
    searchBox.addEventListener('input', e => render(e.target.value));

    // ----- Add / Edit Modal -----
    const userModal = document.getElementById('userModal');
    const userForm = document.getElementById('userForm');
    const userModalTitle = document.getElementById('userModalTitle');
    const closeUserModal = document.getElementById('closeUserModal');
    const cancelUser = document.getElementById('cancelUser');
    const addUserBtn = document.getElementById('addUserBtn');

    const userId = document.getElementById('userId');
    const userName = document.getElementById('userName');
    const userEmail = document.getElementById('userEmail');
    const userRole = document.getElementById('userRole');

    function openEdit(u){
      userModalTitle.textContent = u ? 'Edit User' : 'Add User';
      userId.value = u ? u.id : '';
      userName.value = u ? u.name : '';
      userEmail.value = u ? u.email : '';
      userRole.value = u ? u.role : 'Parent';
      userModal.style.display='flex';

      // Role-based access: only Super Admin can change roles
      userRole.disabled = (currentAdminRole!=='Super Admin');
    }

    closeUserModal.addEventListener('click', ()=> userModal.style.display='none');
    cancelUser.addEventListener('click', ()=> userModal.style.display='none');
    window.addEventListener('click', e=> { if(e.target===userModal) userModal.style.display='none'; });

    addUserBtn.addEventListener('click', ()=> openEdit(null));

    tbody.addEventListener('click', (e)=>{
      const btn = e.target.closest('button');
      if(!btn) return;
      const id = Number(btn.dataset.id);
      const u = users.find(x=>x.id===id);

      if(btn.classList.contains('btn-edit')){
        openEdit(u);
      } else if(btn.dataset.action==='block' || btn.dataset.action==='unblock'){
        if(currentAdminRole!=='Super Admin') return;
        openBlock(u, btn.dataset.action==='block');
      }
    });

    userForm.addEventListener('submit', (e)=>{
      e.preventDefault();
      const id = userId.value ? Number(userId.value) : null;
      if(id){
        // update
        const idx = users.findIndex(x=>x.id===id);
        if(idx>-1){
          users[idx].name = userName.value.trim();
          users[idx].email = userEmail.value.trim();
          if(currentAdminRole==='Super Admin'){ users[idx].role = userRole.value; }
        }
      } else {
        // add
        const nextId = users.length ? Math.max(...users.map(x=>x.id))+1 : 1;
        users.push({
          id: nextId,
          name: userName.value.trim(),
          email: userEmail.value.trim(),
          role: (currentAdminRole==='Super Admin') ? userRole.value : 'Parent',
          status: 'Active'
        });
      }
      saveUsers(users);
      userModal.style.display='none';
      render(searchBox.value);
    });

    // ----- Block / Unblock -----
    const blockModal = document.getElementById('blockModal');
    const blockTitle = document.getElementById('blockTitle');
    const blockMessage = document.getElementById('blockMessage');
    const closeBlockModal = document.getElementById('closeBlockModal');
    const cancelBlock = document.getElementById('cancelBlock');
    const confirmBlock = document.getElementById('confirmBlock');
    let pendingUserId = null;
    let pendingBlock = true;

    function openBlock(user, toBlock){
      pendingUserId = user.id;
      pendingBlock = toBlock;
      blockTitle.textContent = toBlock ? 'Block User' : 'Unblock User';
      blockMessage.textContent = toBlock
        ? `Are you sure you want to BLOCK ${user.name}?`
        : `Are you sure you want to UNBLOCK ${user.name}?`;
      blockModal.style.display='flex';
    }
    closeBlockModal.addEventListener('click', ()=> blockModal.style.display='none');
    cancelBlock.addEventListener('click', ()=> blockModal.style.display='none');
    window.addEventListener('click', e=> { if(e.target===blockModal) blockModal.style.display='none'; });

    confirmBlock.addEventListener('click', ()=>{
      const idx = users.findIndex(x=>x.id===pendingUserId);
      if(idx>-1){
        users[idx].status = pendingBlock ? 'Blocked' : 'Active';
        saveUsers(users);
        render(searchBox.value);
      }
      blockModal.style.display='none';
    });

    // ----- Import JSON -----
    const importBtn = document.getElementById('importBtn');
    const importInput = document.getElementById('importInput');
    importBtn.addEventListener('click', ()=> importInput.click());
    importInput.addEventListener('change', ()=>{
      const file = importInput.files[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try{
          const u = JSON.parse(reader.result);
          const nextId = users.length ? Math.max(...users.map(x=>x.id))+1 : 1;
          users.push({
            id: nextId,
            name: (u.name || '').trim(),
            email: (u.email || '').trim(),
            role: (u.role==='Admin' ? 'Admin' : 'Parent'),
            status: (u.status==='Blocked' ? 'Blocked' : 'Active')
          });
          saveUsers(users); render(searchBox.value);
          alert('User imported.');
        }catch(err){
          console.error(err); alert('Invalid JSON.');
        }
        importInput.value = '';
      };
      reader.readAsText(file);
    });

    // ----- Export CSV -----
    document.getElementById('exportCsvBtn').addEventListener('click', ()=>{
      const rows = [[ 'ID','Name','Email','Role','Status' ]]
        .concat(users.map(u => [u.id, u.name, u.email, u.role, u.status]));
      const csv = rows.map(r => r.map(x => `"${String(x??'').replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'users.csv';
      a.click();
      URL.revokeObjectURL(a.href);
    });
  </script>
</body>
</html>
