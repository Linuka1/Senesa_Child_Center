<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Responsive Senesa child center Website</title>

    <!-- Icons & fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" />

    <!-- Your styles -->
    <link rel="stylesheet" href="style.css" />

    <!-- lightGallery v2 (UMD builds only) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@2.7.2/css/lightgallery-bundle.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/lightgallery@2.7.2/lightgallery.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lightgallery@2.7.2/plugins/zoom/lg-zoom.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lightgallery@2.7.2/plugins/thumbnail/lg-thumbnail.umd.min.js"></script>

    <!-- Keep classic script here so it works on file:// too -->
    <script src="navbar.js?v=1" defer></script>
  </head>

  <body>
    <header class="header">
      <a href="#home" class="logo"><i class="fas fa-school"></i> Senesa Child Center</a>

      <nav class="navbar">
        <a href="#home">Home</a>
        <a href="#About">About</a>
        <a href="#Education">Education</a>
        <a href="#Teacher">Teacher</a>
        <a href="#Activities">Activities</a>
        <a href="#Gallery">Gallery</a>
        <a href="#Books">Books</a>
        <a href="Enrollment.html">Enrollment</a>
        <a href="#Contact">Contact</a>
      </nav>

      <div class="icons">
        <div class="fas fa-user" id="login-btn"></div>
        <div class="fas fa-shopping-cart" id="cart-btn"></div>
        <div class="fas fa-bars" id="menu-btn"></div>
      </div>

      <!-- Modal for Login/Registration -->
      <div class="login-overlay"></div>
      <form class="login-form">
        <div class="close-btn" id="close-login-btn">&times;</div>

        <!-- Login Form -->
        <div class="login-section">
          <h3>Login Now</h3>
          <input type="email" placeholder="Your email" class="box" required />
          <input type="password" placeholder="Your password" class="box" required />
          <input type="submit" value="Login Now" class="btn" />
          <p>Don't have an account? <a href="#" id="register-link">Register here</a></p>
        </div>

        <!-- Registration Form -->
        <div class="register-section" style="display: none;">
          <h3>Create an Account</h3>
          <input type="text" placeholder="Your Name" class="box" id="signup-name" required />
          <input type="email" placeholder="Your Email" class="box" id="signup-email" required />
          <input type="password" placeholder="Your Password" class="box" id="signup-password" required />
          <input type="password" placeholder="Confirm Password" class="box" id="confirm-password" required />
          <input type="submit" value="Register" class="btn" id="register-btn" />
          <p>Already have an account? <a href="#" id="login-link">Login here</a></p>
        </div>
      </form>
    </header>

    <!-- Home -->
    <section class="home" id="home">
      <div class="content">
        <h3>Welcome to our <span>Kindergarten</span></h3>
        <p>Strong foundation for the future</p>
        <a href="#home" class="btn">Learn More</a>
      </div>
      <div class="image">
        <img src="home1.webp" alt="Kindergarten" />
      </div>
      <div class="custom-shape-divider-bottom">
        <svg data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 120" preserveAspectRatio="none">
          <path
            d="M985.66,92.823L743.84,14.19C661.58,31.53,575.78,30.52,493.39,47.24c-57.84,11.7-114.66,25.6-171.45,33.83-68.66,9.82-133.52,3.22-200.39-11.39l-133.17-26.74-107.45,69.94h1200Z"
            class="shape-fill"
          ></path>
        </svg>
      </div>
    </section>

    <!-- About -->
    <section class="About" id="About">
      <h1 class="heading"><span>About</span> Us</h1>
      <div class="row">
        <div class="image">
          <img src="back.png" alt="About Us" />
        </div>
        <div class="content">
          <h3>Exploring, Growing, and Thriving Together</h3>
          <p>
            At SENESA Montessori, we nurture curiosity, independence, and a love for learning in a supportive environment, helping every child grow into their best self.
          </p>
          <a href="#" class="btn">Read More</a>
        </div>
      </div>
    </section>

    <!-- Education -->
    <section class="Education" id="Education">
      <h1 class="heading">Our <span>Education</span></h1>
      <div class="box-container" id="programBox"></div>
    </section>

    <!-- Teacher -->
    <section class="Teacher" id="Teacher">
      <h1 class="heading">our <span>teacher</span></h1>
      <div class="box-container">
        <div class="box">
          <img src="teacher1.png" alt="Nilmini Amarasekara" />
          <h3>Nilmini Amarasekara</h3>
          <p>Teacher</p>
          <div class="contact">
            <a class="wa-btn" data-wa="+94 71 000 1111" data-name="Nilmini Amarasekara" target="_blank" rel="noopener">
              <i class="fab fa-whatsapp"></i><span>WhatsApp</span>
            </a>
          </div>
        </div>

        <div class="box">
          <img src="teacher2.png" alt="Sureka Dias" />
          <h3>Sureka Dias</h3>
          <p>Principal</p>
          <div class="contact">
            <a class="wa-btn" data-wa="+94 77 222 3333" data-name="Sureka Dias" target="_blank" rel="noopener">
              <i class="fab fa-whatsapp"></i><span>WhatsApp</span>
            </a>
          </div>
        </div>

        <div class="box">
          <img src="teacher3.png" alt="Chathurika" />
          <h3>Chathurika</h3>
          <p>Teacher</p>
          <div class="contact">
            <a class="wa-btn" data-wa="+94 70 000 0000" data-name="Chathurika" target="_blank" rel="noopener">
              <i class="fab fa-whatsapp"></i><span>WhatsApp</span>
            </a>
          </div>
        </div>
      </div>
    </section>

    <!-- Activities -->
    <section class="Activities" id="Activities">
      <h1 class="heading">Our <span>Activities</span></h1>
      <div class="box-container">
        <div class="box">
          <img src="act5.webp" alt="Games and Fun" />
          <h3>Games and Fun</h3>
        </div>
        <div class="box">
          <img src="act7.jpg" alt="Creative Arts" />
          <h3>Creative Arts</h3>
        </div>
        <div class="box">
          <img src="act2.png" alt="Outdoor Play" />
          <h3>Outdoor Play</h3>
        </div>
        <div class="box">
          <img src="act8.png" alt="Story Time" />
          <h3>Story Time</h3>
        </div>
        <div class="box">
          <img src="act9.png" alt="Music & Dance" />
          <h3>Music & Dance</h3>
        </div>
        <div class="box">
          <img src="act.jpg" alt="Puzzle Games" />
          <h3>Puzzle Games</h3>
        </div>
        <div class="box">
          <img src="act2.png" alt="Educational Toys" />
          <h3>Educational Toys</h3>
        </div>
        <div class="box">
          <img src="act4.webp" alt="Science Experiments" />
          <h3>Science Experiments</h3>
        </div>
      </div>
    </section>

    <!-- Gallery -->
    <section class="Gallery" id="Gallery">
      <h1 class="heading">our <span>Gallery</span></h1>
      <div class="Gallery-container" id="galleryContainer">
        <!-- Dynamic content will be inserted here -->
      </div>
    </section>

    <!-- Lightbox -->
    <div id="lb" class="lb" aria-hidden="true">
      <button class="lb-close" aria-label="Close">&times;</button>
      <img id="lb-img" alt="" />
    </div>

    <!-- Books -->
      <section class="Books" id="Books">
      <div class="container">
        <h2 class="heading">Available <span>Books</span></h2>
        <div id="books-container" class="books-grid"></div>
      </div>
    </section>

    <!-- Contact -->
    <section class="Contact" id="Contact">
      <h1 class="heading"><span>Contact</span> Us</h1>
      <div class="icons-container">
        <div class="icons">
          <i class="fas fa-clock"></i>
          <h3>Opening Hours:</h3>
          <p>Mon - Thurs: 08:00 AM to 12:30 PM</p>
          <p>Friday: 09:00 AM to 12:00 PM</p>
        </div>
        <div class="icons">
          <i class="fas fa-envelope"></i>
          <h3>Email</h3>
          <p>senesachildcenter@gmail.com</p>
          <p>support@senesachildcenter.com</p>
        </div>
        <div class="icons">
          <i class="fas fa-phone"></i>
          <h3>Phone Number</h3>
          <p>+123-456-7890</p>
          <p>+123-456-7890</p>
        </div>
      </div>

      <div class="row">
        <div class="image">
          <img src="contact.jpg" alt="Contact" />
        </div>
        <form action="">
          <h3>Get in Touch</h3>
          <div class="inputBox">
            <input type="text" placeholder="Your Name" />
            <input type="email" placeholder="abs@gmail.com" />
          </div>
          <div class="inputBox">
            <input type="number" placeholder="Your Number" />
            <input type="text" placeholder="Your Subject" />
          </div>
          <textarea placeholder="Your Message" cols="30" rows="10"></textarea>
          <input type="submit" value="Send Message" class="btn" />
        </form>
      </div>
    </section>

    <!-- Cart -->
    <section class="cart" id="Cart">
      <div class="cart-wrapper">
        <div class="cart-items">
          <h2>Shopping Cart</h2>
          <p class="empty-msg">Your cart is empty. Add books or photos to see them here.</p>
          <a href="#home" class="back-link">← Back to Home</a>
        </div>

        <div class="cart-summary">
          <h3>Summary</h3>
          <div class="summary-row">
            <span class="summary-label">ITEMS</span>
            <span>0</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">DELIVERY</span>
            <span>Rs 0.00</span>
          </div>

          <select>
            <option>Standard Delivery - Rs.250.00</option>
            <option>Express Delivery - Rs.400.00</option>
          </select>

          <div class="summary-row">
            <strong>TOTAL PRICE</strong>
            <strong>Rs.0.00</strong>
          </div>

          <button class="btn-checkout">Proceed to Checkout</button>
        </div>
      </div>
    </section>

    <!-- Footer -->
    <section class="footer">
      <div class="box-container">
        <div class="box">
          <h3><i class="fas fa-school"></i>Senesa Child Center</h3>
          <p>
            Welcome to Senesa Child Center, a place dedicated to providing quality education and care for young children. We focus on building a strong foundation for their future success.
          </p>
        </div>

        <div class="box">
          <h3>quick link</h3>
          <a href="#"><i class="fas fa-caret-right"></i>enroll now</a>
          <a href="#"><i class="fas fa-caret-right"></i>parent poral</a>
          <a href="#"><i class="fas fa-caret-right"></i>school calender</a>
          <a href="#"><i class="fas fa-caret-right"></i>lunch menu</a>
          <a href="#"><i class="fas fa-caret-right"></i>school supply</a>
        </div>

        <div class="box">
          <h3>category</h3>
          <a href="#"><i class="fas fa-caret-right"></i>about us</a>
          <a href="#"><i class="fas fa-caret-right"></i>academics</a>
          <a href="#"><i class="fas fa-caret-right"></i>admissions</a>
          <a href="#"><i class="fas fa-caret-right"></i>news & events</a>
          <a href="#"><i class="fas fa-caret-right"></i>contact us</a>
        </div>

        <div class="box">
          <h3>extra links</h3>
          <a href="#"><i class="fas fa-caret-right"></i>privacy policy</a>
          <a href="#"><i class="fas fa-caret-right"></i>terms of use</a>
          <a href="#"><i class="fas fa-caret-right"></i>site map</a>
          <a href="#"><i class="fas fa-caret-right"></i>F&Qs</a>
          <a href="#"><i class="fas fa-caret-right"></i>accessibility statements</a>
        </div>
      </div>

      <div class="credit">
        <span>&copy; 2025 Senesa Child Center by Linky |</span>
        <a href="Admin/admin-login.html" class="admin-btn">Admin Login</a>
      </div>
    </section>

    <!-- ===== Inline JS ===== -->
    <script>
      (() => {
        // --- lightGallery init ---
        const galleryRoot = document.querySelector('.Gallery .Gallery-container');
        if (galleryRoot && !galleryRoot.dataset.lgInited) {
          galleryRoot.dataset.lgInited = '1';
          lightGallery(galleryRoot, {
            selector: 'a.box',
            plugins: [lgZoom, lgThumbnail],
            licenseKey: 'dev-build',
            download: false,
            speed: 300,
            hash: false,
            click: false,
            closable: true,
            escKey: true
          });
        }

        // --- Auth modal toggle ---
        const loginLink = document.getElementById('login-link');
        const registerLink = document.getElementById('register-link');
        const loginSection = document.querySelector('.login-section');
        const registerSection = document.querySelector('.register-section');
        const signupPassword = document.getElementById('signup-password');
        const confirmPassword = document.getElementById('confirm-password');
        const registerBtn = document.getElementById('register-btn');
        const loginForm = document.querySelector('.login-form');
        const loginOverlay = document.querySelector('.login-overlay');
        const loginBtn = document.getElementById('login-btn');
        const closeLoginBtn = document.getElementById('close-login-btn');

        registerLink?.addEventListener('click', (e) => {
          e.preventDefault();
          loginSection.style.display = 'none';
          registerSection.style.display = 'block';
        });

        loginLink?.addEventListener('click', (e) => {
          e.preventDefault();
          registerSection.style.display = 'none';
          loginSection.style.display = 'block';
        });

        registerBtn?.addEventListener('click', (e) => {
          if (signupPassword.value !== confirmPassword.value) {
            e.preventDefault();
            alert('Passwords do not match!');
          } else {
            alert('Registration successful!');
          }
        });

        const openModal = () => {
          loginForm.classList.add('active');
          loginOverlay.classList.add('active');
        };
        const closeModal = () => {
          loginForm.classList.remove('active');
          loginOverlay.classList.remove('active');
        };

        loginBtn?.addEventListener('click', openModal);
        closeLoginBtn?.addEventListener('click', closeModal);
        loginOverlay?.addEventListener('click', closeModal);

        // --- Cart scroll ---
        const cartBtn = document.getElementById('cart-btn');
        const cartSection = document.getElementById('Cart');
        cartBtn?.addEventListener('click', () => {
          cartSection?.scrollIntoView({ behavior: 'smooth' });
        });

        // Scroll to top on load
        window.addEventListener('load', () => window.scrollTo(0, 0));

        // --- WhatsApp links for teachers ---
        function normalizeToE164(raw) {
          if (!raw) return '';
          let s = raw.replace(/[^\d+]/g, '').trim();
          if (s.startsWith('+')) s = s.slice(1);
          if (s.startsWith('0')) s = '94' + s.slice(1);
          return s;
        }
        function makeWaLink(num, name) {
          const e164 = normalizeToE164(num);
          const msg = encodeURIComponent(`Hello ${name}, I’m a parent from Senesa Child Center.`);
          return `https://wa.me/${e164}?text=${msg}`;
        }
        document.querySelectorAll('.wa-btn').forEach((a) => {
          const n = a.dataset.wa || '';
          const name = a.dataset.name || 'teacher';
          a.href = makeWaLink(n, name);
        });

        // --- Load Education Programs dynamically ---
        async function loadPrograms() {
        const container = document.getElementById('programBox');
        if (!container) return;
        try {
          const res = await fetch('api/programs_public.php');
          const json = await res.json();
          if (!json.ok) throw new Error(json.error || 'Failed');
          container.innerHTML = '';
          json.data.forEach(p => {
            const div = document.createElement('div');
            div.className = 'box';
            div.innerHTML = `
              <h3>${p.name}</h3>
              <p>${p.summary || ''}</p>
              <img src="${p.image || 'placeholder.png'}" alt="${p.name}">
            `;
            container.appendChild(div);
          });
        } catch (err) {
          console.error(err);
          container.innerHTML = '<p style="color:red">Failed to load programs.</p>';
        }
        }

        window.addEventListener('DOMContentLoaded', loadPrograms);
      })();

      const API_URL = 'api/books.php?action=list'; // adjust path if needed
      const booksGrid = document.getElementById('booksGrid');

      function fmt(n) {
        return 'Rs. ' + Number(n).toLocaleString('en-LK');
      }

      function badge(stock, status){
        if(status==='Hidden') return ''; // skip hidden books
        if(stock<=0) return '<span class="badge out">Out of Stock</span>';
        return '<span class="badge in">In Stock</span>';
      }

      async function loadBooks() {
        try {
          const res = await fetch(API_URL);
          const json = await res.json();
          if (!json.ok) throw new Error(json.error || 'Error loading books');

          const data = json.data.filter(b => b.status !== 'Hidden'); // only show visible
          booksGrid.innerHTML = '';

          if (data.length === 0) {
            booksGrid.innerHTML = '<p style="text-align:center;color:#777">No books available at the moment.</p>';
            return;
          }

          data.forEach(book => {
            const div = document.createElement('div');
            div.className = 'book-card';
            div.innerHTML = `
              <div class="card">
                <img src="${book.image ? 'http://localhost/Senesa_Child_Center' + book.image : 'default-book.jpg'}" alt="${book.title}" class="book-cover"/>
                <h3>${book.title || 'Untitled'}</h3>
                <p>${book.author || ''}</p>
                <p class="price">${fmt(book.price)}</p>
                ${badge(book.stock, book.status)}
                <button class="add-to-cart">Add To Cart</button>
              </div>
            `;
            booksGrid.appendChild(div);
          });
        } catch (err) {
          console.error(err);
          booksGrid.innerHTML = '<p style="text-align:center;color:red">Error loading books</p>';
        }
      }

      document.addEventListener('DOMContentLoaded', loadBooks);


      fetch('api/books.php?action=list')
        .then(res => res.json())
        .then(json => {
          if (!json.ok) return;
          const wrap = document.getElementById('books-container');
          wrap.innerHTML = '';

          json.data
            .filter(b => b.status !== 'Hidden') // skip hidden books
            .forEach(b => {
              wrap.innerHTML += `
                <div class="book-card" style="text-align:center; margin-bottom:4rem;">
                  <img src="${b.image}" alt="${b.title}" style="width:200px;height:auto;border-radius:10px;">
                  <h3 style="font-weight:bold;margin-top:1rem;">${b.title}</h3>
                  <p style="color:#666;">${b.author}</p>
                  <p class="price">Rs. ${b.price.toLocaleString()}</p>
                  <button class="btn" onclick="addToCart(${b.id})">Add To Cart</button>
                </div>`;
            });
        });

      function addToCart(id){
        // later you can add real cart logic here
        alert('Added book ID ' + id + ' to cart!');
      }

          // Prefer API that already returns only Active items.
// Falls back to ?action=list and filters on the client if needed.
const PREFERRED_API = 'api/gallery.php?action=public';
const FALLBACK_API  = 'api/gallery.php?action=list';

// Works whether the site is at / or /SomeFolder/
const segments = window.location.pathname.split('/').filter(Boolean);
// If URL is /Folder/page.html -> ROOT = /Folder/ ; If /index.html -> ROOT = /
const ROOT = segments.length > 1 ? ('/' + segments[0] + '/') : '/';

function buildPath(p) {
  if (!p) return '';
  if (/^https?:\/\//i.test(p) || /^data:/i.test(p) || p.startsWith('/')) return p;
  const clean = String(p).replace(/^(\.\/|\.\.\/)+/, ''); // remove ./ and ../
  return ROOT + clean; // prepend detected root
}


// Fetch gallery data, using public endpoint first, then fallback
async function fetchGalleryData() {
  try {
    const r = await fetch(PREFERRED_API);
    const j = await r.json();
    if (j.ok) return Array.isArray(j.data) ? j.data : [];
  } catch (_) {}
  // Fallback: get all items, filter to Active on client
  const r2 = await fetch(FALLBACK_API);
  const j2 = await r2.json();
  if (!j2.ok) throw new Error(j2.error || 'Error loading gallery');
  const rows = Array.isArray(j2.data) ? j2.data : [];
  return rows.filter(x => String(x.status || '').toLowerCase() === 'active');
}

// Render gallery into the container
function renderGallery(items) {
  const galleryContainer = document.getElementById('galleryContainer');
  galleryContainer.innerHTML = '';

  if (!items.length) {
    galleryContainer.innerHTML =
      '<p style="text-align:center;color:#777">No gallery items available at the moment.</p>';
    return;
  }

  items.forEach(item => {
    const fullImagePath  = buildPath(item.src);
    const thumbImagePath = buildPath(item.thumb || item.src);

    const a = document.createElement('a');
    a.href = encodeURI(fullImagePath);
    a.classList.add('box');

    const img = document.createElement('img');
    img.src = encodeURI(thumbImagePath);
    img.alt = item.caption || 'Gallery Image';

    // If thumb fails, try full image; if that fails, use a 1x1 transparent PNG
    img.onerror = () => {
      if (img.dataset.triedFull !== '1' && fullImagePath && img.src !== fullImagePath) {
        img.dataset.triedFull = '1';
        img.src = encodeURI(fullImagePath);
      } else {
        img.src =
          'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQIW2NgYGD4DwABGQFJ4i4cWQAAAABJRU5ErkJggg==';
      }
    };

    const iconDiv = document.createElement('div');
    iconDiv.classList.add('icon');
    const icon = document.createElement('i');
    icon.classList.add('fas', 'fa-plus');
    iconDiv.appendChild(icon);

    a.appendChild(img);
    a.appendChild(iconDiv);
    galleryContainer.appendChild(a);
  });
}

// Load + render
async function loadGallery() {
  try {
    const data = await fetchGalleryData();
    renderGallery(data);
  } catch (err) {
    console.error(err);
    const galleryContainer = document.getElementById('galleryContainer');
    galleryContainer.innerHTML =
      '<p style="text-align:center;color:red">Error loading gallery</p>';
  }
}
window.addEventListener('DOMContentLoaded', loadGallery);

/* -------------------------
   1) Tiny cart in localStorage
------------------------- */
const CART_KEY = 'senesa_cart_v1';
const cart = {
  get(){ return JSON.parse(localStorage.getItem(CART_KEY) || '[]'); },
  save(items){ localStorage.setItem(CART_KEY, JSON.stringify(items)); },
  add({id, title, price, qty=1}){
    const items = this.get();
    const ex = items.find(x => x.product_id === id);
    if (ex){ ex.qty += qty; ex.unit_price = price; }
    else { items.push({ product_type:'book', product_id:id, title, unit_price:price, qty }); }
    this.save(items);
    return items;
  },
  updateQty(id, qty){
    const items = this.get();
    const it = items.find(x => x.product_id === id);
    if (it){ it.qty = Math.max(1, qty|0); this.save(items); }
  },
  remove(id){ this.save(this.get().filter(x => x.product_id !== id)); },
  clear(){ localStorage.removeItem(CART_KEY); },
  total(){ return this.get().reduce((s,x)=>s + x.qty*x.unit_price, 0); }
};

function fmtLKR(n){ return 'Rs. ' + Number(n||0).toLocaleString('en-LK'); }

/* -------------------------
   2) Load books (keeps your section)
      and wire Add To Cart
------------------------- */
let booksCache = []; // so addToCart can look up title/price by id

async function loadBooksPublic(){
  try{
    const res = await fetch('api/books.php?action=list');
    const json = await res.json();
    if(!json.ok) throw new Error(json.error || 'Error loading books');
    booksCache = Array.isArray(json.data) ? json.data.filter(b => b.status !== 'Hidden') : [];

    const wrap = document.getElementById('books-container');
    wrap.innerHTML = '';
    if(!booksCache.length){
      wrap.innerHTML = '<p style="text-align:center;color:#777">No books available at the moment.</p>';
      return;
    }

    booksCache.forEach(b => {
      wrap.innerHTML += `
        <div class="book-card" style="text-align:center; margin-bottom:4rem;">
          <img src="${b.image}" alt="${b.title}" style="width:200px;height:auto;border-radius:10px;">
          <h3 style="font-weight:bold;margin-top:1rem;">${b.title}</h3>
          <p style="color:#666;">${b.author || ''}</p>
          <p class="price">${fmtLKR(b.price)}</p>
          <button class="btn" onclick="addToCart(${b.id})">Add To Cart</button>
        </div>`;
    });
  }catch(err){
    console.error(err);
    const wrap = document.getElementById('books-container');
    wrap.innerHTML = '<p style="text-align:center;color:red">Error loading books</p>';
  }
}
document.addEventListener('DOMContentLoaded', loadBooksPublic);

/* Add to cart (called by the button above) */
function addToCart(id){
  const b = booksCache.find(x => x.id === id);
  if(!b){ alert('Book not found'); return; }
  cart.add({ id: b.id, title: b.title, price: Number(b.price), qty: 1 });
  renderCart();
  // smooth scroll to the Cart section
  document.getElementById('Cart')?.scrollIntoView({ behavior:'smooth' });
}

/* -------------------------
   3) Render Cart section and summary
------------------------- */
const cartItemsBox = document.querySelector('.cart-items');
const emptyMsg      = cartItemsBox?.querySelector('.empty-msg');
const summaryBox    = document.querySelector('.cart-summary');
const itemsCountEl  = summaryBox?.querySelector('.summary-row:nth-of-type(1) span:last-child');
const deliveryEl    = summaryBox?.querySelector('.summary-row:nth-of-type(2) span:last-child');
const deliverySel   = summaryBox?.querySelector('select');
const totalPriceEl  = summaryBox?.querySelector('.summary-row:last-of-type strong:last-child');
const checkoutBtn   = summaryBox?.querySelector('.btn-checkout');

function parseDelivery(){
  // reads e.g. "Standard Delivery - Rs.250.00"
  const t = deliverySel?.selectedOptions?.[0]?.text || '';
  const m = t.match(/Rs\.?\s*([\d,]+)/i);
  return m ? Number(m[1].replace(/,/g,'')) : 0;
}

function renderCart(){
  if(!cartItemsBox) return;
  const items = cart.get();

  // clear old rows (keep the heading + back link)
  const staticNodes = Array.from(cartItemsBox.children).slice(0,2); // <h2> + empty msg/back link wrapper
  cartItemsBox.innerHTML = '';
  staticNodes.forEach(n => cartItemsBox.appendChild(n));

  if(!items.length){
    emptyMsg?.classList.remove('hidden');
    if(itemsCountEl) itemsCountEl.textContent = '0';
    if(totalPriceEl) totalPriceEl.textContent = fmtLKR(0);
    if(deliveryEl) deliveryEl.textContent = fmtLKR(0);
    return;
  }
  emptyMsg?.classList.add('hidden');

  items.forEach(it => {
    const row = document.createElement('div');
    row.className = 'cart-row';
    row.dataset.id = String(it.product_id);
    row.style.cssText = 'display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 0;border-bottom:1px solid #eee';

    row.innerHTML = `
      <div style="flex:1 1 auto">${it.title}</div>
      <div style="width:90px;text-align:right">${fmtLKR(it.unit_price)}</div>
      <div style="width:130px;display:flex;gap:6px;justify-content:flex-end;align-items:center">
        <input class="qty" type="number" min="1" value="${it.qty}" style="width:70px;padding:6px 8px;border:1px solid #ddd;border-radius:8px">
        <button class="remove" style="background:#fee2e2;border:none;border-radius:8px;padding:6px 10px;cursor:pointer">Remove</button>
      </div>
      <div style="width:110px;text-align:right;font-weight:600">${fmtLKR(it.qty*it.unit_price)}</div>
    `;
    cartItemsBox.appendChild(row);
  });

  // summary
  const itemsCount = items.reduce((n,it)=>n+it.qty,0);
  const itemsTotal = cart.total();
  const delivery   = parseDelivery();
  if(itemsCountEl) itemsCountEl.textContent = String(itemsCount);
  if(deliveryEl)   deliveryEl.textContent   = fmtLKR(delivery);
  if(totalPriceEl) totalPriceEl.textContent = fmtLKR(itemsTotal + delivery);
}

// qty/remove handlers
cartItemsBox?.addEventListener('input', (e)=>{
  const row = e.target.closest('.cart-row'); if(!row) return;
  if (e.target.classList.contains('qty')){
    cart.updateQty(Number(row.dataset.id), Number(e.target.value));
    renderCart();
  }
});
cartItemsBox?.addEventListener('click', (e)=>{
  const row = e.target.closest('.cart-row'); if(!row) return;
  if (e.target.classList.contains('remove')){
    cart.remove(Number(row.dataset.id));
    renderCart();
  }
});
deliverySel?.addEventListener('change', renderCart);

// initial paint
renderCart();

/* -------------------------
   4) Proceed To Checkout -> create DB order
      (shows a simple prompt for name/email for now)
------------------------- */
async function createOrderInDB(payload){
  const res  = await fetch('api/orders.php?action=create', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });
  const text = await res.text();
  let data; try{ data = JSON.parse(text); }catch(_){ throw new Error('Server did not return JSON:\n'+text); }
  if(!res.ok || data.ok === false) throw new Error(data.error || 'Request failed');
  return data; // {ok:true, order_id, order_code, total}
}

checkoutBtn?.addEventListener('click', async ()=>{
  const items = cart.get();
  if(!items.length){ alert('Your cart is empty.'); return; }

  // very simple capture for now; replace with your own form later
  const buyerName  = prompt('Enter your name:');
  const buyerEmail = prompt('Enter your email:');
  if(!buyerName || !buyerEmail){ alert('Name and email are required.'); return; }

  const delivery = parseDelivery();
  const payload = {
    orderId: '', // let server generate
    createdAt: new Date().toISOString(),
    buyer: { name: buyerName.trim(), email: buyerEmail.trim() },
    items: items.map(x => ({
      bookId: x.product_id,
      qty: x.qty,
      unitPrice: x.unit_price,
      title: x.title
    })),
    amount: cart.total(),              // server will also recompute
    paymentStatus: 'pending',          // not paid yet
    fulfillmentStatus: 'new',          // not packed yet
    paymentRef: '',
    notes: `Delivery ${fmtLKR(delivery)}`
  };

  try{
    const resp = await createOrderInDB(payload);
    cart.clear();
    renderCart();
    alert('Order placed! Your code: ' + (resp.order_code || ''));
    // optionally: scroll to top or show a thank-you block
  }catch(err){
    console.error(err);
    alert('Checkout failed: ' + err.message);
  }
});



    </script>
  </body>
</html>
